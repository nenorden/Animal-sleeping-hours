
---
title: "Animal Sleeping Hours"
author: "Eliza Norden"
date: "9 mars 2018"
output: pdf_document
---
## Have a look at the data
```{r}
library(ggplot2)
library(tidyr)
library(MASS)
library(boot)

sleep_data = read.csv("sleep1.csv")

rownames(sleep_data) = sleep_data[,1]
sleep_data = sleep_data[,-1]
sleep_data = sleep_data[,c(3:10)] # omit slowWaveSleep and dreamSleep
sleep_data = na.omit(sleep_data)

# scatter plot of sleep_data vs other variables
sleep_data %>%
  gather(-sleep, key = "var", value = "value") %>% 
  ggplot(aes(x = value, y = sleep)) +
  geom_point() +
  facet_wrap(~ var, scales = "free") 
  

```
  

## Remove highly correlated variables
``` {r}
corr = cor(sleep_data)
corr[!lower.tri(corr)] = 0 
corr_lim = 0.90
# remove variables that are highly correlated
sleep_data = sleep_data[,apply(corr,2,function(x) all(abs(x)<corr_lim))]
#sleep_data = sleep_data[,c(1:2,4:5,7:8)] #manual removal (to remove predation instead of danger)
```


## Find linear model by LOOCV
``` {r}

dep_var <- 'sleep'
indep_vars <- setdiff(names(sleep_data), dep_var)

# Model fits for all combinations of predictors. Copied from stackExchange. 
glms <- Reduce(append, lapply(seq_along(indep_vars),
  function(num_vars) {
    Reduce(append, apply(combn(length(indep_vars), num_vars), 2, function(vars) {
      formula_string <- paste(c(dep_var, paste(indep_vars[vars], collapse = "+")), collapse = '~')
      structure(list(glm(as.formula(formula_string), data = sleep_data)), .Names = formula_string)
    }))
  }
))

dim = dim(sleep_data)[1]
sub = 1:dim 
train = sub[1:(dim/2)]
test = sub[(dim/2+1):dim]

formulas.comb = names(glms) # formula strings
N = length(formulas.comb)

cv.error = c()
# loop over all predictor combinations, calculate MSE by LOOCV
for(i in 1:N) {
  cv.error[i] = cv.glm(glm(as.formula(formulas.comb[i]), data=sleep_data[train,]), data=sleep_data[train,])$delta[1]
}
# data frame holding formulas and MSE, in ascending order
cv.df = data.frame(formula = formulas.comb, MSE= cv.error)
cv.df = cv.df[order(cv.error),]
# technical step converting formula to a factor so that ggplot gets that it should plot in order
cv.df$formula = factor(cv.df$formula, levels = cv.df$formula[order(cv.df$MSE)])
rownames(cv.df) = cv.df$formula

# plot MSE 
ggplot(data=cv.df, aes(x=factor(cv.df$formula), y=cv.df$MSE)) + geom_point() + theme(axis.text.x = element_text(angle=90)) + 
  xlab("Formula") + ylab("MSE") + ggtitle("MSE for different formulas, calculated with LOOCV")   #theme(axis.text.x=element_blank())

form= as.formula(as.character(cv.df$formula[1]))
fit = glm(form, data=sleep_data, subset=train)
summary(fit)
```



## get prediction intervals by bootstrapping
``` {r}
library(boot)
# species names
names = rownames(sleep_data)
# predictors in formula
vars = all.vars(form[[3]])
# data frame holding test subset of sleep_data
test.df = data.frame(row.names = names[test], sleep_data[,vars][test,])

# boot statistic to predict sleep
bootstat = function(formula, data, indices) {
  fit = lm(formula, data[indices,])
  return(predict(fit, test.df))
}

# bootstrap using formula found by LOOCV
boot = boot(data=sleep_data, statistic = bootstat, R=10000, formula=form)
# predicted sleep and standard deviation
boot.df = data.frame(fit=boot$t0,std=apply(boot$t,2,sd) )
rownames(boot.df) = names[test]

sleep.df = data.frame(sleep = sleep_data$sleep)

# MSE when comparing predictions to known data
mse(sleep.df[test,], boot.df$fit)

# plot predictions, error boxes (+- one standard dev)
p = ggplot(data=boot.df,aes(x=names[test], y=boot.df$fit)) +
  geom_point(shape=3) +
  geom_errorbar(data=boot.df,aes(ymax = boot.df$fit + boot.df$std, ymin = boot.df$fit - boot.df$std)) +
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "Animal" ,y = "Daily sleep (hrs)", title="Hours of daily sleep predicted by bootstrap") 

# plot actual sleep hours as comparison
p + geom_point(aes(x=names[test], y=sleep.df[test,]), color="red", shape=2)


```
## Ignore this block for now - basically does same as above but bootstraps model coefficients instead of making predictions
``` {r}

bootstatcoef = function(formula, data, indices) {
  fit = lm(formula, data[indices,])
  return(coef(fit))
}

bootcoef = boot(data=sleep_data, statistic = bootstatcoef, R=10000, formula=form)

meancoef = apply(bootcoef$t, 2, mean)
meanstd = apply(bootcoef$t, 2, sd)

sleep_pred = data.frame(pred=meancoef[1] + meancoef[2]*sleep_data$gestation + meancoef[3]*sleep_data$danger, lwr = (meancoef[1]-meanstd[1]) + (meancoef[2]-meanstd[2])*sleep_data$gestation + (meancoef[3]-meanstd[3])*sleep_data$danger, upr  = (meancoef[1]+meanstd[1]) + (meancoef[2]+meanstd[2])*sleep_data$gestation + (meancoef[3]+meanstd[3])*sleep_data$danger )
rownames(sleep_pred) = names


p=ggplot(data=sleep_pred[test,],aes(x=names[test], y=sleep_pred$pred[test])) +
  geom_point(shape=3) +
  geom_errorbar(data=sleep_pred[test,],aes(ymax = sleep_pred$upr[test], ymin = sleep_pred$lwr[test])) +
  theme(axis.text.x = element_text(angle=45)) +
  labs(x = "Animal" ,y = "Daily sleep (hrs)", title="Hours of daily sleep predicted by bootstrap") 

p+geom_point(aes(x=names[test], y=sleep_data$sleep[test]), color="red", shape=2)
library(hydroGOF)
print(mse(sleep_pred$pred, sleep_data$sleep))
```